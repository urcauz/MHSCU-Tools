<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MHSCU Community Dashboard</title>
<style>
  body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 0; }
  header { background: #0052cc; color: white; padding: 15px; text-align: center; }
  #dashboard { padding: 20px; max-width: 1200px; margin: auto; }
  .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
  th { background: #f0f0f0; }
  img.avatar { width: 40px; border-radius: 50%; vertical-align: middle; margin-right: 10px; }
  input[type="text"] { padding: 8px; width: 100%; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
  button { padding: 5px 10px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
  button.mute { background: #ffa500; color: white; }
  button.unmute { background: #28a745; color: white; }
  button.kick { background: #dc3545; color: white; }
  button.ban { background: #800000; color: white; }
  button.timeout { background: #ffc107; color: white; }
  #logout { float: right; margin-top: -35px; margin-right: 20px; cursor: pointer; color: white; }
</style>
</head>
<body>

<header>
  <h1>MHSCU Community Dashboard</h1>
  <span id="logout">Logout</span>
</header>

<div id="dashboard">
  <div class="card">
    <h2>Server Stats</h2>
    <p>Total Members: <span id="totalMembers">0</span></p>
    <p>Online Members: <span id="onlineMembers">0</span></p>
    <p>Muted Members: <span id="mutedUsers">0</span></p>
    <p>Bots: <span id="botCount">0</span></p>
  </div>

  <div class="card">
    <h2>Leaderboard</h2>
    <ul id="leaderboardList"></ul>
  </div>

  <div class="card">
    <h2>Users</h2>
    <input type="text" id="userSearch" placeholder="Search users...">
    <table>
      <thead>
        <tr><th>User</th><th>Roles</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </div>
</div>

<script>
const API_BASE = "http://localhost:3000/api"; // your bot API
let DASHBOARD_PASSWORD = localStorage.getItem("dashboardPassword");

// Login
async function login() {
  if(!DASHBOARD_PASSWORD) {
    const pw = prompt("Enter dashboard password:");
    if(pw !== 'admin123') { // set your password here
      alert("Wrong password!");
      document.body.innerHTML = "<h1 style='text-align:center;margin-top:50px;'>Unauthorized</h1>";
      return false;
    }
    localStorage.setItem("dashboardPassword", pw);
    DASHBOARD_PASSWORD = pw;
  }
  return true;
}

// Fetch server stats
async function fetchServerStats() {
  const res = await fetch(`${API_BASE}/status`, { headers: { Authorization: 'Bearer ' + DASHBOARD_PASSWORD } });
  const data = await res.json();
  document.getElementById('totalMembers').innerText = data.users;
  document.getElementById('onlineMembers').innerText = data.onlineMembers;
  document.getElementById('mutedUsers').innerText = data.mutedUsers;
  document.getElementById('botCount').innerText = data.botCount;
}

// Fetch leaderboard
async function fetchLeaderboard() {
  const res = await fetch(`${API_BASE}/leaderboard`, { headers: { Authorization: 'Bearer ' + DASHBOARD_PASSWORD } });
  const data = await res.json();
  const list = document.getElementById('leaderboardList');
  list.innerHTML = '';
  Object.entries(data).sort((a,b)=>b[1]-a[1]).forEach(([id,count],i)=>{
    const li = document.createElement('li');
    li.innerText = `#${i+1}: ${id} - ${count} messages`;
    list.appendChild(li);
  });
}

// Fetch users
let users = [];
async function fetchUsers() {
  const res = await fetch(`${API_BASE}/users`, { headers: { Authorization: 'Bearer ' + DASHBOARD_PASSWORD } });
  users = await res.json();
  renderUsers(users);
}

// Render users
function renderUsers(list) {
  const tbody = document.getElementById('userTable');
  tbody.innerHTML = '';
  list.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${u.avatar}" class="avatar">${u.username}</td>
      <td>${u.roles.join(', ')}</td>
      <td>${u.status}</td>
      <td>
        <button class="mute" onclick="moderate('${u.id}','mute')">Mute</button>
        <button class="unmute" onclick="moderate('${u.id}','unmute')">Unmute</button>
        <button class="kick" onclick="moderate('${u.id}','kick')">Kick</button>
        <button class="ban" onclick="moderate('${u.id}','ban')">Ban</button>
        <button class="timeout" onclick="moderate('${u.id}','timeout')">Timeout</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Search users
document.getElementById('userSearch').addEventListener('input', (e)=>{
  const term = e.target.value.toLowerCase();
  const filtered = users.filter(u=>u.username.toLowerCase().includes(term));
  renderUsers(filtered);
});

// Moderate user
async function moderate(userId, action) {
  const reason = prompt(`Reason for ${action}?`);
  const res = await fetch(`${API_BASE}/moderation`, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', Authorization: 'Bearer ' + DASHBOARD_PASSWORD },
    body: JSON.stringify({ userId, action, reason })
  });
  const data = await res.json();
  alert(data.message);
  fetchServerStats();
  fetchUsers();
}

// Logout
document.getElementById('logout').onclick = ()=>{
  localStorage.removeItem('dashboardPassword');
  location.reload();
}

// Initial load
login().then(ok=>{
  if(ok){
    fetchServerStats();
    fetchLeaderboard();
    fetchUsers();
    setInterval(()=>{ fetchServerStats(); fetchLeaderboard(); fetchUsers(); }, 15000); // refresh every 15s
  }
});
</script>

</body>
</html>
