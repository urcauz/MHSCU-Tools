<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MHSCU Community Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; color: #111; transition: background 0.3s, color 0.3s; }
  body.dark { background: #18191c; color: #e4e6eb; }
  header { padding: 20px; background: #5865f2; color: white; display: flex; justify-content: space-between; align-items: center; }
  .dark header { background: #333; }
  .container { padding: 20px; max-width: 1200px; margin: auto; }
  h2 { margin-top: 40px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ccc; }
  .dark th, .dark td { border-color: #555; }
  button { margin: 2px; padding: 5px 10px; cursor: pointer; }
  .status { font-weight: bold; }
  .login-container { display: flex; flex-direction: column; max-width: 300px; margin: 100px auto; }
  .login-container input { margin-bottom: 10px; padding: 8px; }
  .badge { padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.8em; }
  .role-admin { background: #f04747; }
  .role-moderator { background: #faa81a; }
  .role-member { background: #43b581; }
</style>
</head>
<body>
<header>
  <div>MHSCU Community Dashboard</div>
  <div>
    <button id="themeToggle">üåô Toggle Dark/Light</button>
    <span id="statusIndicator" class="status">Offline</span>
  </div>
</header>

<div class="container" id="dashboard" style="display:none;">
  
  <h2>Server Stats</h2>
  <div id="stats">
    <p>Total Members: <span id="totalMembers">0</span></p>
    <p>Muted Users: <span id="mutedUsers">0</span></p>
    <p>Bot Online: <span id="botOnline">‚ùå</span></p>
  </div>

  <h2>Leaderboard / Engagement</h2>
  <table id="leaderboardTable">
    <thead>
      <tr><th>#</th><th>User</th><th>Messages</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="resetLeaderboardBtn">Reset Leaderboard</button>

  <h2>Moderation Logs</h2>
  <table id="logsTable">
    <thead>
      <tr><th>Time</th><th>Action</th><th>User</th><th>Moderator</th><th>Reason</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Announcements</h2>
  <textarea id="announcementText" rows="3" style="width:100%;"></textarea>
  <select id="announcementChannel">
    <option value="leaderboard">Leaderboard</option>
    <option value="suggestions">Suggestions</option>
    <option value="logs">Logs</option>
  </select>
  <button id="sendAnnouncementBtn">Send Announcement</button>

  <h2>Users</h2>
  <input type="text" id="searchUser" placeholder="Search username or ID..." style="margin-bottom:10px;padding:5px;width:300px;">
  <table id="usersTable">
    <thead>
      <tr><th>User</th><th>Messages</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="login-container" id="loginContainer">
  <h2>Login</h2>
  <input type="password" id="dashboardPassword" placeholder="Enter password">
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<script>
const API_BASE = 'https://mhscu-tools.onrender.com';
const DASHBOARD_PASSWORD = localStorage.getItem('dashboardPassword') || null;

const loginContainer = document.getElementById('loginContainer');
const dashboard = document.getElementById('dashboard');

const statusIndicator = document.getElementById('statusIndicator');
const totalMembersEl = document.getElementById('totalMembers');
const mutedUsersEl = document.getElementById('mutedUsers');
const botOnlineEl = document.getElementById('botOnline');

const leaderboardTableBody = document.querySelector('#leaderboardTable tbody');
const logsTableBody = document.querySelector('#logsTable tbody');
const usersTableBody = document.querySelector('#usersTable tbody');

const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
});

function setStatus(online) {
  statusIndicator.textContent = online ? '‚úÖ Online' : '‚ùå Offline';
  botOnlineEl.textContent = online ? '‚úÖ' : '‚ùå';
}
const res = await fetch(`${API_BASE}/api/members`);
const members = await res.json();

async function fetchStats() {
  try {
    const res = await fetch(`${API_BASE}/api/status`);
    const data = await res.json();
    totalMembersEl.textContent = data.users || 0;
    mutedUsersEl.textContent = data.mutedUsers || 0;
    setStatus(data.online);
  } catch (err) {
    console.error(err);
    setStatus(false);
  }
}

async function fetchLeaderboard() {
  try {
    const res = await fetch(`${API_BASE}/api/leaderboard`);
    const data = await res.json();
    leaderboardTableBody.innerHTML = '';
    usersTableBody.innerHTML = '';
    const sorted = Object.entries(data).sort((a,b) => b[1]-a[1]);
    sorted.forEach(([id, count], i) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${i+1}</td><td>${id}</td><td>${count}</td>`;
      leaderboardTableBody.appendChild(row);

      const userRow = document.createElement('tr');
      userRow.innerHTML = `<td>${id}</td><td>${count}</td>
        <td>
          <button onclick="moderate('${id}','mute')">Mute</button>
          <button onclick="moderate('${id}','unmute')">Unmute</button>
          <button onclick="moderate('${id}','kick')">Kick</button>
          <button onclick="moderate('${id}','ban')">Ban</button>
          <button onclick="moderate('${id}','timeout')">Timeout</button>
        </td>`;
      usersTableBody.appendChild(userRow);
    });
  } catch (err) {
    console.error(err);
  }
}

async function fetchLogs() {
  try {
    const res = await fetch(`${API_BASE}/api/logs`);
    const data = await res.json();
    logsTableBody.innerHTML = '';
    data.forEach(log => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${new Date(log.time).toLocaleString()}</td>
        <td>${log.action || 'Action'}</td>
        <td>${log.user || '-'}</td>
        <td>${log.moderator || '-'}</td>
        <td>${log.reason || '-'}</td>`;
      logsTableBody.appendChild(row);
    });
  } catch(err){console.error(err);}
}

async function moderate(userId, action) {
  const reason = prompt("Enter reason (optional)");
  const duration = action === 'timeout' ? prompt("Timeout duration in minutes", "10") : null;

  try {
    const res = await fetch(`${API_BASE}/api/${action}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + DASHBOARD_PASSWORD },
      body: JSON.stringify({ userId, reason, duration })
    });
    const data = await res.json();
    alert(data.success ? `${action} successful` : `Failed: ${data.error}`);
    fetchLeaderboard();
    fetchLogs();
  } catch(err){console.error(err);}
}

// Announcement
document.getElementById('sendAnnouncementBtn').addEventListener('click', async ()=>{
  const message = document.getElementById('announcementText').value;
  const channel = document.getElementById('announcementChannel').value;
  try {
    const res = await fetch(`${API_BASE}/api/announcement`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer '+DASHBOARD_PASSWORD },
      body: JSON.stringify({ channel, message })
    });
    const data = await res.json();
    alert(data.success ? "Announcement sent!" : `Failed: ${data.error}`);
  } catch(err){console.error(err);}
});

// Reset leaderboard
document.getElementById('resetLeaderboardBtn').addEventListener('click', async ()=>{
  if(!confirm("Reset leaderboard?")) return;
  try {
    const res = await fetch(`${API_BASE}/api/reset-leaderboard`, {
      method:'POST',
      headers:{ 'Authorization': 'Bearer '+DASHBOARD_PASSWORD }
    });
    const data = await res.json();
    alert(data.success ? "Leaderboard reset!" : `Failed: ${data.error}`);
    fetchLeaderboard();
  } catch(err){console.error(err);}
});

// Login handling
function showDashboard() {
  loginContainer.style.display = 'none';
  dashboard.style.display = 'block';
  fetchStats();
  fetchLeaderboard();
  fetchLogs();
}

if(DASHBOARD_PASSWORD){
  showDashboard();
} else {
  document.getElementById('loginBtn').addEventListener('click', ()=>{
    const pass = document.getElementById('dashboardPassword').value;
    if(pass === 'admin123'){ // match your server .env
      localStorage.setItem('dashboardPassword', pass);
      location.reload();
    } else {
      document.getElementById('loginError').textContent = 'Incorrect password';
    }
  });
}

// Search filter
document.getElementById('searchUser').addEventListener('input', e=>{
  const term = e.target.value.toLowerCase();
  usersTableBody.querySelectorAll('tr').forEach(row=>{
    row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
  });
});

// Refresh data every 10 seconds
setInterval(()=>{
  fetchStats();
  fetchLeaderboard();
  fetchLogs();
}, 10000);

</script>
</body>
</html>
