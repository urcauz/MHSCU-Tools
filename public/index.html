<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MHSCU Community Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; color:#222; }
    body.dark { background:#181818; color:#f0f0f0; }
    header { background:#5865F2; color:white; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
    header button { padding:.5rem 1rem; cursor:pointer; border:none; border-radius:5px; background:#fff;color:#5865F2; font-weight:bold; }
    main { display:flex; flex-wrap:wrap; padding:1rem; gap:1rem; }
    section { background:white; border-radius:10px; padding:1rem; flex:1 1 300px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    body.dark section { background:#282828; box-shadow:0 2px 8px rgba(0,0,0,0.5); }
    table { width:100%; border-collapse:collapse; }
    table th, table td { border:1px solid #ccc; padding:.5rem; text-align:left; }
    body.dark table th, body.dark table td { border-color:#444; }
    .user-actions button { margin-right:0.3rem; }
    input, select, textarea { width:100%; padding:.5rem; margin:.3rem 0; border-radius:5px; border:1px solid #ccc; }
    body.dark input, body.dark select, body.dark textarea { border-color:#444; background:#333; color:#fff; }
  </style>
</head>
<body>
  <header>
    <h1>MHSCU Community Dashboard</h1>
    <div>
      <button id="themeToggle">Dark/Light</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <main>
    <!-- Server Stats -->
    <section>
      <h2>Server Stats</h2>
      <p>Members: <span id="totalMembers">0</span></p>
      <p>Online: <span id="onlineMembers">0</span></p>
      <p>Bots: <span id="botCount">0</span></p>
      <p>Muted Users: <span id="mutedUsers">0</span></p>
    </section>

    <!-- Leaderboard -->
    <section>
      <h2>Leaderboard</h2>
      <canvas id="leaderboardChart" height="200"></canvas>
      <button id="resetLeaderboardBtn">Reset Leaderboard</button>
      <button id="announceLeaderboardBtn">Announce Winners</button>
    </section>

    <!-- Users Table -->
    <section>
      <h2>Users</h2>
      <input type="text" id="searchUser" placeholder="Search by username..." />
      <table id="usersTable">
        <thead>
          <tr>
            <th>Avatar</th>
            <th>Username</th>
            <th>Roles</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Moderation Logs -->
    <section>
      <h2>Moderation Logs</h2>
      <table id="logsTable">
        <thead>
          <tr>
            <th>Time</th>
            <th>Action</th>
            <th>User</th>
            <th>Moderator</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Announcements -->
    <section>
      <h2>Announcements</h2>
      <select id="announcementChannel">
        <option value="leaderboard">Leaderboard</option>
        <option value="suggestions">Suggestions</option>
        <option value="logs">Logs</option>
      </select>
      <textarea id="announcementMessage" placeholder="Your message..."></textarea>
      <button id="sendAnnouncementBtn">Send Announcement</button>
    </section>
  </main>

  <script>
    const DASHBOARD_PASSWORD = prompt("Enter dashboard password:");
    if(DASHBOARD_PASSWORD !== 'admin123'){ // your password
      alert("Wrong password!");
      document.body.innerHTML = "<h1 style='text-align:center;margin-top:50px;'>Unauthorized</h1>";
    }

    const themeToggle = document.getElementById('themeToggle');
    themeToggle.onclick = () => document.body.classList.toggle('dark');

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.onclick = () => location.reload();

    let users = [];
    let leaderboardData = {};

    async function fetchServerData(){
      const status = await fetch('/api/status', { headers:{Authorization:'Bearer admin123'} }).then(r=>r.json());
      document.getElementById('totalMembers').innerText = status.users;
      document.getElementById('mutedUsers').innerText = status.mutedUsers;
      document.getElementById('onlineMembers').innerText = "N/A";
      document.getElementById('botCount').innerText = "N/A";

      const leaderboard = await fetch('/api/leaderboard', { headers:{Authorization:'Bearer admin123'} }).then(r=>r.json());
      leaderboardData = leaderboard;
      renderLeaderboard(leaderboard);
    }

    async function fetchUsers(){
      // simulate fetching from bot; replace with proper API if added
      const res = await fetch('/api/status', { headers:{Authorization:'Bearer admin123'} });
      const data = await res.json();
      users = Object.keys(leaderboardData).map(id=>({id, username:"User"+id, roles:["Member"], status:"online"}));
      renderUsers(users);
    }

    function renderLeaderboard(data){
      const ctx = document.getElementById('leaderboardChart').getContext('2d');
      if(window.lbChart) window.lbChart.destroy();
      const labels = Object.keys(data).slice(0,10);
      const values = Object.values(data).slice(0,10);
      window.lbChart = new Chart(ctx,{
        type:'bar',
        data:{labels, datasets:[{label:'Messages',data:values,backgroundColor:'#5865F2'}]},
        options:{responsive:true, plugins:{legend:{display:false}}}
      });
    }

    function renderUsers(list){
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      list.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><img src="https://cdn.discordapp.com/embed/avatars/0.png" width="32" height="32"/></td>
          <td>${u.username}</td>
          <td>${u.roles.join(', ')}</td>
          <td>${u.status}</td>
          <td class="user-actions">
            <button onclick="moderate('${u.id}','mute')">Mute</button>
            <button onclick="moderate('${u.id}','unmute')">Unmute</button>
            <button onclick="moderate('${u.id}','kick')">Kick</button>
            <button onclick="moderate('${u.id}','ban')">Ban</button>
            <button onclick="moderate('${u.id}','timeout')">Timeout</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function moderate(userId, action){
      const reason = prompt(`Reason for ${action}?`) || "No reason provided";
      fetch(`/api/moderation`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', Authorization:'Bearer admin123' },
        body: JSON.stringify({userId, action, reason})
      }).then(r=>r.json()).then(r=>alert(r.message || "Done"));
    }

    const searchInput = document.getElementById('searchUser');
    searchInput.oninput = () => {
      const filtered = users.filter(u => u.username.toLowerCase().includes(searchInput.value.toLowerCase()));
      renderUsers(filtered);
    }

    document.getElementById('resetLeaderboardBtn').onclick = () => {
      fetch('/api/reset-leaderboard', {method:'POST',headers:{Authorization:'Bearer admin123'}})
      .then(r=>r.json()).then(r=>{alert(r.message); fetchServerData();});
    }

    document.getElementById('announceLeaderboardBtn').onclick = () => {
      const message = "ðŸŽ‰ Weekly leaderboard announced!";
      fetch('/api/announcement', {method:'POST', headers:{Authorization:'Bearer admin123','Content-Type':'application/json'},body:JSON.stringify({channel:'leaderboard', message})})
      .then(r=>r.json()).then(r=>alert(r.message));
    }

    document.getElementById('sendAnnouncementBtn').onclick = () => {
      const channel = document.getElementById('announcementChannel').value;
      const message = document.getElementById('announcementMessage').value;
      fetch('/api/announcement', {method:'POST', headers:{Authorization:'Bearer admin123','Content-Type':'application/json'},body:JSON.stringify({channel,message})})
      .then(r=>r.json()).then(r=>alert(r.message));
    }

    fetchServerData();
    fetchUsers();
  </script>
</body>
</html>
